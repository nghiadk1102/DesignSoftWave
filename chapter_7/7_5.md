7.5 Pass-through variables
Một dạng khác của việc sao chép API qua các class là Pass-through variables, là một biến được truyền qua một chuỗi dài các phương thức. Hình 7.2 (a) cho thấy một ví dụ từ dịch vụ trung tâm dữ liệu. Đối số dòng lệnh mô tả các chứng chỉ để sử dụng cho giao tiếp an toàn. Thông tin này chỉ cần thiết bởi một phương thức cấp thấp m3, phương thức này gọi một phương thức thư viện để mở một ổ cắm, nhưng nó được truyền qua tất cả các phương thức trên đường dẫn giữa main và m3. Biến cert xuất hiện trong chữ ký của mỗi phương thức trung gian. Các Pass-through variables làm tăng thêm độ phức tạp vì chúng buộc tất cả các phương thức trung gian phải nhận thức được sự tồn tại của chúng, ngay cả khi các phương thức này không sử dụng cho các biến. Hơn nữa, nếu một biến mới xuất hiện (ví dụ: một hệ thống ban đầu được xây dựng mà không hỗ trợ chứng chỉ, nhưng sau đó bạn quyết định thêm hỗ trợ đó), bạn có thể phải sửa đổi một số lượng lớn giao diện và phương thức để chuyển biến qua tất cả các con đường có liên quan.

Việc loại bỏ các biến truyền qua có thể là một thách thức. Một cách tiếp cận là xem liệu đã có một đối tượng được chia sẻ giữa các phương thức trên cùng và dưới cùng chưa. Trong ví dụ về dịch vụ trung tâm dữ liệu của Hình 7.2, có lẽ có một đối tượng chứa thông tin khác về giao tiếp mạng, có sẵn cho cả main và m3. Nếu vậy, main có thể lưu trữ thông tin chứng chỉ trong đối tượng đó, vì vậy nó không cần phải được chuyển qua tất cả các phương thức can thiệp trên đường dẫn đến m3 (xem Hình 7.2 (b)). Tuy nhiên, nếu có một đối tượng như vậy, thì bản thân nó có thể là một biến truyền qua (làm cách nào khác để m3 có thể truy cập vào nó?). Một cách tiếp cận khác là lưu trữ thông tin trong một biến toàn cục, như trong Hình 7.2 (c). Điều này tránh được sự cần thiết phải truyền thông tin từ phương thức này sang phương thức khác, nhưng các biến toàn cục hầu như luôn tạo ra các vấn đề khác. Ví dụ, các biến toàn cục làm cho không thể tạo hai phiên bản độc lập của cùng một hệ thống trong cùng một quá trình, vì các quyền truy cập vào các biến toàn cục sẽ xung đột. Có vẻ như bạn sẽ không cần nhiều phiên bản trong quá trình sản xuất, nhưng chúng thường hữu ích trong việc thử nghiệm. Giải pháp tôi thường sử dụng nhất là giới thiệu một đối tượng ngữ cảnh như trong Hình 7.2 (d). Một ngữ cảnh lưu trữ tất cả trạng thái toàn cục của ứng dụng (bất kỳ thứ gì có thể là biến truyền qua hoặc biến toàn cục). Hầu hết các ứng dụng có nhiều biến trong trạng thái toàn cục của chúng, đại diện cho những thứ như tùy chọn cấu hình, hệ thống con được chia sẻ và bộ đếm hiệu suất. Có một đối tượng ngữ cảnh cho mỗi phiên bản của hệ thống. Bối cảnh cho phép nhiều phiên bản của hệ thống cùng tồn tại trong một quá trình duy nhất, mỗi phiên bản có ngữ cảnh riêng.

Thật không may, ngữ cảnh có thể sẽ cần thiết ở nhiều nơi, vì vậy nó có khả năng trở thành một biến truyền qua. Để giảm số lượng các phương pháp phải biết về nó, một tham chiếu đến ngữ cảnh có thể được lưu trong hầu hết các đối tượng chính của hệ thống. Trong ví dụ của Hình 7.2 (d), lớp chứa m3 lưu trữ một tham chiếu đến ngữ cảnh dưới dạng một biến thể hiện trong các đối tượng của nó. Khi một đối tượng mới được tạo, phương thức tạo sẽ lấy tham chiếu ngữ cảnh từ đối tượng của nó và chuyển nó đến phương thức khởi tạo cho đối tượng mới. Với cách tiếp cận này, ngữ cảnh có sẵn ở mọi nơi, nhưng nó chỉ xuất hiện như một đối số rõ ràng trong các hàm tạo. Đối tượng ngữ cảnh thống nhất việc xử lý tất cả thông tin toàn cục của hệ thống và loại bỏ sự cần thiết của các biến truyền qua. Nếu một biến mới cần được thêm vào, nó có thể được thêm vào đối tượng ngữ cảnh; không có mã hiện có nào bị ảnh hưởng ngoại trừ hàm tạo và hàm hủy cho ngữ cảnh. Bối cảnh giúp dễ dàng xác định và quản lý trạng thái chung của hệ thống, vì tất cả được lưu trữ ở một nơi. Bối cảnh cũng thuận tiện cho việc thử nghiệm: mã thử nghiệm có thể thay đổi cấu hình chung của ứng dụng bằng cách sửa đổi các trường trong ngữ cảnh. Sẽ khó khăn hơn nhiều để thực hiện những thay đổi như vậy nếu hệ thống sử dụng các biến truyền qua. Các bối cảnh không phải là một giải pháp lý tưởng. Các biến được lưu trữ trong một ngữ cảnh có hầu hết các nhược điểm của các biến toàn cục; ví dụ, có thể không rõ ràng tại sao một biến cụ thể lại có mặt hoặc nó được sử dụng ở đâu. Nếu không có kỷ luật, bối cảnh có thể biến thành một túi dữ liệu khổng lồ tạo ra sự phụ thuộc rõ ràng trong toàn bộ hệ thống. Các ngữ cảnh cũng có thể tạo ra các vấn đề an toàn luồng; cách tốt nhất để tránh các vấn đề là để các biến trong ngữ cảnh là bất biến. Thật không may, tôi đã không tìm thấy giải pháp tốt hơn các ngữ cảnh.